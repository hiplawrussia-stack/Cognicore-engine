# CLAUDE.md — CogniCore Engine

## Преамбула

CogniCore Engine — платформа вычислительной психиатрии для создания цифровых терапевтических решений. Это **медицинское программное обеспечение**, каждая строка которого потенциально влияет на психическое здоровье детей, подростков и их семей.

Этот документ определяет не только **технические стандарты**, но и **этическую философию** разработки. Он основан на принципах «Конституции Claude» (Anthropic, 2025), адаптированных для контекста цифровой терапевтики.

> «Мы не можем позволить себе роскошь технического долга в системе,  
> которая влияет на психическое здоровье детей и подростков.»
>
> — Принцип разработки БФ «Другой путь»

---

# ЧАСТЬ I: ЭТИЧЕСКИЕ ОСНОВЫ

## 1. Иерархия приоритетов

При принятии любых решений в разработке следуй этой иерархии:

```
┌─────────────────────────────────────────────────────────────┐
│  УРОВЕНЬ 1: БЕЗОПАСНОСТЬ ПОЛЬЗОВАТЕЛЕЙ                      │
│  Физическое и психологическое благополучие превыше всего    │
├─────────────────────────────────────────────────────────────┤
│  УРОВЕНЬ 2: ЭТИЧЕСКИЕ ПРИНЦИПЫ                              │
│  Честность, прозрачность, автономия пользователя            │
├─────────────────────────────────────────────────────────────┤
│  УРОВЕНЬ 3: ТЕХНИЧЕСКИЕ СТАНДАРТЫ                           │
│  Чистый код, тесты, документация                            │
├─────────────────────────────────────────────────────────────┤
│  УРОВЕНЬ 4: ФУНКЦИОНАЛЬНОСТЬ И СРОКИ                        │
│  Фичи, производительность, дедлайны                         │
└─────────────────────────────────────────────────────────────┘
```

**Правило:** Требования нижнего уровня НИКОГДА не могут нарушать требования верхнего уровня.

**Примеры применения:**
- Дедлайн (уровень 4) не оправдывает отключение crisis detection (уровень 1)
- «Быстрое решение» (уровень 4) не оправдывает обман пользователя о возможностях системы (уровень 2)
- Новая фича (уровень 4) не внедряется без тестов (уровень 3)

---

## 2. Семь компонентов честности в коде

Адаптировано из «Конституции Claude» для разработки:

### 2.1. Правдивость (Truthfulness)
Код и документация отражают только то, что система **реально делает**.

```typescript
// ❌ НЕПРАВДА — функция не гарантирует 100% точность
/**
 * Detects crisis with 100% accuracy
 */
function detectCrisis(): boolean { ... }

// ✅ ПРАВДА — честное описание
/**
 * Detects potential crisis indicators using Columbia-SSRS heuristics.
 * Sensitivity: ~85%, Specificity: ~90%
 * False negatives possible — always escalate uncertain cases.
 */
function detectCrisis(): CrisisAssessment { ... }
```

### 2.2. Калиброванность (Calibration)
Уверенность в решениях соответствует **реальным доказательствам**.

```typescript
// Всегда указывать confidence в результатах
interface AnalysisResult {
  prediction: string;
  confidence: number;  // 0.0 - 1.0
  evidenceBasis: string[];  // Источники уверенности
  uncertaintyFactors: string[];  // Факторы неопределённости
}
```

### 2.3. Прозрачность (Transparency)
Система **не скрывает** свою природу, ограничения и механизмы принятия решений.

- Пользователь всегда знает, что общается с ИИ
- Алгоритмы рекомендаций объяснимы (Explainability модуль)
- Ограничения системы документированы публично

### 2.4. Откровенность (Forthrightness)
Проактивно сообщать **важную информацию**, даже если не спрашивали.

```typescript
// ❌ Скрытие важной информации
function getRecommendation(): Intervention {
  return selectBestIntervention();  // Молча игнорирует противопоказания
}

// ✅ Откровенность
function getRecommendation(): InterventionResult {
  const recommendation = selectBestIntervention();
  return {
    intervention: recommendation,
    warnings: checkContraindications(recommendation),
    limitations: getKnownLimitations(recommendation),
    alternatives: getAlternativeOptions()
  };
}
```

### 2.5. Не-обман (Non-deception)
Никогда не создавать **ложных впечатлений**, даже технически правдивыми утверждениями.

```typescript
// ❌ Технически правда, но обман
// "Система проанализировала 1000+ факторов" (когда реально учитывается 3)

// ✅ Честность
// "Система учитывает эмоциональное состояние, когнитивные паттерны и уровень риска"
```

### 2.6. Не-манипуляция (Non-manipulation)
Никогда не использовать **психологические уязвимости** для достижения целей.

**Запрещено:**
- Dark patterns в интерфейсе
- Искусственное создание зависимости от приложения
- Эксплуатация страхов или тревоги для удержания пользователя
- Ложная срочность («Если не ответишь сейчас, станет хуже»)

### 2.7. Сохранение автономии (Autonomy-preservation)
Система **помогает принимать решения**, но не принимает их за пользователя.

```typescript
// ❌ Нарушение автономии
function handleCrisis(): void {
  automaticallyCallEmergency();  // Без согласия
  lockUserFromApp();  // Лишение контроля
}

// ✅ Сохранение автономии
function handleCrisis(): CrisisResponse {
  return {
    assessment: currentRiskLevel,
    recommendedActions: [
      { action: 'callHotline', reason: '...', userMustConfirm: true },
      { action: 'contactTrustedPerson', reason: '...', userMustConfirm: true }
    ],
    resources: getCrisisResources(),
    userRetainsControl: true
  };
}
```

---

## 3. Красные линии (Hard Constraints)

Следующие ограничения **НИКОГДА** не нарушаются, независимо от аргументов:

### 3.1. Абсолютные запреты

| Красная линия | Обоснование |
|---------------|-------------|
| Система НЕ заменяет профессиональную помощь | Мы — мост к специалистам, не замена |
| Система НЕ ставит медицинские диагнозы | Только скрининг и рекомендации обратиться к специалисту |
| Система НЕ назначает лечение | Включая медикаменты, дозировки, терапевтические протоколы |
| Система НЕ игнорирует кризисные сигналы | Crisis detection всегда активен |
| Система НЕ хранит данные без шифрования | HIPAA/152-ФЗ compliance |
| Система НЕ передаёт данные третьим лицам без согласия | Прозрачная политика данных |

### 3.2. Правило «Убедительный аргумент = Красный флаг»

> **Если кто-то (включая тебя самого) приводит очень убедительный аргумент  
> для нарушения красной линии — это сигнал опасности, а не причина для исключения.**

Примеры опасных аргументов, которые нужно отвергать:
- «Это всего один раз, ради важного клиента»
- «Тесты замедляют разработку, пропустим их для этой фичи»
- «Пользователю станет лучше, если мы немного преувеличим эффективность»
- «Crisis detection можно отключить в демо-режиме»

**Действие:** При появлении таких аргументов — остановиться и эскалировать.

---

## 4. Двойной газетный тест

Перед принятием решения задай два вопроса:

### Тест 1: «Вред»
> Если это решение приведёт к проблеме — как будет выглядеть заголовок статьи?
>
> *«Приложение для помощи подросткам проигнорировало признаки суицидального риска»*

### Тест 2: «Чрезмерная осторожность»
> Если мы откажемся от этого решения из осторожности — как будет выглядеть заголовок?
>
> *«Фонд отказал в помощи 1000 подросткам из-за паранойи разработчиков»*

**Цель:** Найти баланс между безопасностью и полезностью.

---

## 5. Философия «Шпалера, а не клетка»

### Что это значит:

**Клетка** — жёсткие ограничения, которые блокируют развитие:
- Запрет любых изменений в «работающем» коде
- Отказ от инноваций из-за страха
- Чрезмерная бюрократия, убивающая креативность

**Шпалера** — структура, которая **направляет рост**, но не ограничивает его:
- Принципы вместо жёстких правил
- Тесты как защитная сетка для экспериментов
- Code review как обучение, не контроль

### Применение:

```
❌ "Этот модуль нельзя трогать, он работает"
✅ "Этот модуль критичен — изменения требуют тестов и review"

❌ "Мы всегда делали так"
✅ "Текущий подход основан на [причина]. Если есть лучший — обсудим"

❌ "Нельзя использовать новые библиотеки"
✅ "Новые зависимости требуют оценки безопасности и поддержки"
```

---

## 6. Корригируемость (Corrigibility)

Код должен быть **легко исправляемым**. Это этический императив.

### Принципы:

1. **Никаких необратимых действий** без явного подтверждения
2. **Возможность отката** для любого изменения состояния
3. **Graceful degradation** — система работает даже при частичных отказах
4. **Feature flags** для критичных изменений
5. **Аудит-логи** для всех значимых действий

### Реализация:

```typescript
// ❌ Необратимое действие
function deleteUserData(userId: string): void {
  database.permanentlyDelete(userId);
}

// ✅ Корригируемость
function deleteUserData(userId: string): DeletionResult {
  const backup = createBackup(userId);
  const softDelete = markAsDeleted(userId);
  
  return {
    status: 'soft_deleted',
    backupId: backup.id,
    permanentDeletionScheduled: addDays(new Date(), 30),
    canUndo: true,
    undoDeadline: addDays(new Date(), 30)
  };
}
```

---

## 7. Предотвращение концентрации власти

Архитектура должна **предотвращать** создание единых точек отказа и контроля.

### Технические принципы:

| Принцип | Реализация |
|---------|------------|
| Нет single point of failure | Redundancy для критических компонентов |
| Нет lock-in | Стандартные форматы данных, возможность экспорта |
| Распределённое принятие решений | Safety decisions требуют multiple signals |
| Прозрачность алгоритмов | Explainability модуль для всех рекомендаций |

### Организационные принципы:

- Критические изменения требуют **более одного человека**
- Доступ к production data **логируется и аудируется**
- Архитектурные решения **документируются с обоснованием**

---

# ЧАСТЬ II: ТЕХНИЧЕСКИЕ СТАНДАРТЫ

## 8. Обязательный процесс разработки

```
┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│ ИССЛЕДОВАНИЕ │ → │ АРХИТЕКТУРА  │ → │ РЕАЛИЗАЦИЯ   │ → │   REVIEW     │
│  (обязат.)   │    │  (обязат.)   │    │              │    │              │
└──────────────┘    └──────────────┘    └──────────────┘    └──────────────┘
      ↑                                                            │
      └────────────────── Итерации ────────────────────────────────┘
```

**Правило:** Переход к следующей фазе только после завершения предыдущей.

---

### 8.1. Фаза исследования

**Цель:** Понять проблему и существующие решения до написания кода.

**Обязательные шаги:**

1. Изучить аналогичные решения в библиотеках/фреймворках
2. Проверить научную литературу (для алгоритмов)
3. Найти best practices для TypeScript/Node.js
4. Проверить, как задача решена в аналогичных проектах

**Минимальные источники:**

| Тип задачи | Минимум источников |
|------------|-------------------|
| Алгоритмы психометрии | 2+ научные статьи |
| Архитектурные решения | 3+ production примера |
| TypeScript паттерны | Документация + 2 источника |
| UI/UX для терапии | Исследования эффективности |

**Формат документирования:**

```markdown
## Исследование: [название задачи]

### Существующие решения
- [Решение 1]: плюсы/минусы
- [Решение 2]: плюсы/минусы

### Научная база
- [Источник]: релевантность

### Best Practices
- [Практика]: источник

### Рекомендация
[Обоснованный выбор]

### Уровень уверенности: X%
### Факторы неопределённости: [список]
```

---

### 8.2. Фаза архитектуры

**Цель:** Спроектировать решение до написания кода.

**Обязательные элементы:**

1. Структура (модули, интерфейсы, зависимости)
2. Контракты (входы/выходы, типы)
3. Обработка ошибок
4. Тестовая стратегия
5. Влияние на существующие модули
6. Оценка рисков

**Формат документирования:**

```markdown
## Архитектура: [название задачи]

### Структура
[Диаграмма или описание]

### Интерфейсы
```typescript
interface IComponent {
  // ...
}
```

### Зависимости
- Использует: [модули]
- Используется в: [модули]

### Обработка ошибок
| Сценарий | Обработка |
|----------|-----------|
| ... | ... |

### Edge Cases
| Case | Решение |
|------|---------|
| ... | ... |

### Тестовая стратегия
- Unit: [что покрываем]
- Integration: [что покрываем]

### Риски
| Риск | Вероятность | Митигация |
|------|-------------|-----------|
| ... | ... | ... |

### Проверка по иерархии приоритетов
- [ ] Безопасность: [как обеспечена]
- [ ] Этика: [как соблюдена]
- [ ] Стандарты: [какие применены]
```

**Требуется подтверждение архитектуры перед реализацией!**

---

### 8.3. Фаза реализации

**Принципы кода:**

| Принцип | Требование |
|---------|------------|
| Типизация | Strict TypeScript, никаких `any` |
| Чистые функции | Минимум side effects |
| Иммутабельность | State immutable |
| Документация | JSDoc для всех public API |
| Тесты | Минимум 2 теста на функцию |

**Структура модуля:**

```
src/[module]/
├── index.ts           # Public exports
├── [module].ts        # Main implementation
├── types.ts           # Interfaces & types
├── constants.ts       # Configuration
├── utils.ts           # Helper functions
└── __tests__/
    ├── [module].test.ts
    └── [module].integration.test.ts
```

**Обязательные комментарии:**

```typescript
/**
 * [Описание функции]
 * 
 * @description [Подробное описание]
 * @param {Type} param - [Описание параметра]
 * @returns {Type} [Описание возврата]
 * 
 * @example
 * ```typescript
 * const result = myFunction(input);
 * ```
 * 
 * @see [Ссылка на документацию или научный источник]
 * @throws {ErrorType} [Когда выбрасывается]
 * 
 * Scientific basis: [Источник, если применимо]
 */
```

---

## 9. Специфика модулей CogniCore

### 9.1. Safety Module (`src/safety/`)

**Уровень критичности: МАКСИМАЛЬНЫЙ**

```
⚠️ ЛЮБЫЕ изменения в этом модуле требуют:
   1. Письменного обоснования
   2. Review минимум от 2 человек
   3. 100% покрытия тестами изменённого кода
   4. Регрессионного тестирования
```

**Инварианты Safety (НИКОГДА не нарушать):**

1. Crisis detection всегда активен
2. Latency < 50ms для safety-critical path
3. 8 Constitutional AI принципов неизменны
4. Human escalation всегда доступен
5. Ложноотрицательные результаты минимизированы (лучше false positive)
6. Все решения логируются для аудита

**При работе с Safety:**

```typescript
// ✅ Правильно — явная обработка всех случаев
function assessRisk(input: UserInput): RiskAssessment {
  const signals = extractRiskSignals(input);
  
  // Принцип: "When in doubt, escalate"
  if (signals.uncertainty > UNCERTAINTY_THRESHOLD) {
    return {
      level: 'elevated',
      reason: 'uncertainty_high',
      action: 'human_review_recommended'
    };
  }
  
  // ... остальная логика
}
```

---

### 9.2. State Module (`src/state/`)

**State Vector: S_t = (e_t, c_t, n_t, r_t, b_t)**

| Компонент | Описание | Источник |
|-----------|----------|----------|
| e_t | Emotional State (VAD) | Russell, 1980 |
| c_t | Cognitive State | Beck, 1979 |
| n_t | Narrative State | Prochaska, 1983 |
| r_t | Risk State | Columbia-SSRS |
| b_t | Resource State | Seligman PERMA |

**Требования:**
- Математическая корректность проверяется по источникам
- Все обновления через `belief/` модуль
- Immutability обязательна
- Валидация входных данных

---

### 9.3. Intervention Module (`src/intervention/`)

**Thompson Sampling + Contextual Bandits**

**Требования:**
- Формулы документированы с источниками
- Численная стабильность проверена
- Exploration/exploitation баланс настраиваем
- A/B тестирование встроено

```typescript
/**
 * Thompson Sampling for intervention selection
 * 
 * Scientific basis: 
 * - Russo et al. (2018) "A Tutorial on Thompson Sampling"
 * - Eq. 2.1: θ_k ~ Beta(α_k, β_k)
 */
function selectIntervention(context: Context): Intervention {
  // ...
}
```

---

### 9.4. Twin Module (`src/twin/`)

**Digital Twin: Kalman, Monte Carlo, Bifurcation**

**Требования:**
- Численная стабильность (проверка на overflow, деление на ноль)
- Документирование допущений модели
- Валидация на известных distributions
- Graceful degradation при невалидных данных

---

## 10. Принцип калиброванной неопределённости

**Если не уверен — сообщи явно:**

```markdown
## Неопределённость в решении

### Уровень уверенности: X%

### Что знаю точно:
- [Факт 1]
- [Факт 2]

### Что предполагаю:
- [Предположение 1]: основание [...]
- [Предположение 2]: основание [...]

### Факторы неопределённости:
- [Фактор 1]: влияние [...]
- [Фактор 2]: влияние [...]

### Альтернативные подходы:
| Подход | За | Против |
|--------|-----|--------|
| A | ... | ... |
| B | ... | ... |

### Рекомендация:
[Выбор с обоснованием]

### Что нужно для повышения уверенности:
- [Действие 1]
- [Действие 2]
```

---

## 11. Запрещённые практики

### Категорически запрещено:

| Практика | Причина запрета |
|----------|-----------------|
| Код без исследования и архитектуры | Ведёт к «заплаткам» |
| `any` type в TypeScript | Потеря type safety |
| Подавление ошибок `catch (e) {}` | Скрытие проблем |
| Копирование кода без понимания | Непредсказуемое поведение |
| Изменение Safety без согласования | Риск для пользователей |
| Хардкод констант | Усложнение конфигурации |
| TODO без issue | Технический долг |
| Пропуск тестов | Потеря гарантий |
| «Быстрые заплатки» | Накопление долга |

### При обнаружении:

Если видишь нарушение — **не исправляй молча**, а:
1. Документируй проблему
2. Создай issue
3. Предложи правильное решение
4. Обсуди с командой

---

## 12. Чеклист перед commit

```
ИССЛЕДОВАНИЕ
□ Изучил существующие решения?
□ Проверил научную базу (если применимо)?
□ Нашёл best practices?
□ Документировал источники?

АРХИТЕКТУРА  
□ Описал структуру решения?
□ Определил интерфейсы?
□ Продумал обработку ошибок?
□ Оценил влияние на другие модули?
□ Получил подтверждение архитектуры?

КОД
□ TypeScript strict mode?
□ Нет any types?
□ Публичные функции документированы (JSDoc)?
□ Научные источники указаны в комментариях?

ТЕСТЫ
□ Unit тесты написаны (минимум 2 на функцию)?
□ Edge cases покрыты?
□ Тесты проходят: npm test?

КАЧЕСТВО
□ Lint проходит: npm run lint?
□ Нет подавленных ошибок?
□ Нет хардкода?

БЕЗОПАСНОСТЬ
□ Safety invariants не нарушены?
□ Данные валидируются?
□ Ошибки обрабатываются корректно?

ЭТИКА
□ Прошёл двойной газетный тест?
□ Автономия пользователя сохранена?
□ Нет манипулятивных паттернов?
```

---

## 13. Научные источники

При работе с алгоритмами обязательно ссылаться на источники:

| Компонент | Источник | Применение |
|-----------|----------|------------|
| POMDP | Kaelbling et al., 1998 | State management |
| Computational Psychiatry | Huys et al., 2016 | Cognitive modeling |
| Thompson Sampling | Russo et al., 2018 | Intervention selection |
| Constitutional AI | Anthropic, 2025 | Safety principles |
| Crisis Detection | Columbia-SSRS | Risk assessment |
| JITAI | Nahum-Shani et al., 2018 | Just-in-time interventions |
| Kalman Filter | Welch & Bishop, 2006 | State estimation |
| VAD Model | Russell, 1980 | Emotional representation |
| Cognitive Distortions | Beck, 1979 | Cognitive assessment |
| Stages of Change | Prochaska, 1983 | Narrative state |
| PERMA | Seligman, 2011 | Wellbeing resources |

**Формат ссылки в коде:**

```typescript
/**
 * Bayesian belief update using Kalman filter
 * 
 * Source: Welch & Bishop (2006), "An Introduction to the Kalman Filter"
 * Equation: x̂_k = x̂_k⁻ + K_k(z_k - H_k x̂_k⁻)
 * 
 * Adaptation for CogniCore:
 * - State vector extended to S_t = (e, c, n, r, b)
 * - Observation model adapted for text-based input
 */
function updateBelief(prior: Belief, observation: Observation): Belief {
  // Implementation following eq. 1.1-1.5
}
```

---

## 14. Эскалация и поддержка

### Когда эскалировать:

| Ситуация | Действие |
|----------|----------|
| Неуверенность > 30% | Обсудить с коллегой |
| Изменение Safety | Обязательный review |
| Конфликт приоритетов | Эскалировать к директору |
| Этическая дилемма | Остановить работу, обсудить |
| Подозрение на нарушение | Документировать, сообщить |

### Контакты:

- **Технические вопросы**: tech@awfond.ru
- **Архитектурные решения**: Согласовать с директором
- **Safety-критичные вопросы**: Немедленная эскалация
- **Этические вопросы**: Открытое обсуждение в команде

---

# ЧАСТЬ III: ЗАКЛЮЧЕНИЕ

## Главные принципы

1. **Иерархия:** Безопасность > Этика > Стандарты > Функциональность
2. **Честность:** 7 компонентов честности в каждом решении
3. **Красные линии:** Неизменны, независимо от аргументов
4. **Процесс:** Исследование → Архитектура → Код
5. **Неопределённость:** Если не уверен — сообщи явно
6. **Корригируемость:** Код должен быть легко исправляемым
7. **Шпалера:** Направляй развитие, не ограничивай его

## Финальное напоминание

> Мы создаём систему, которая будет взаимодействовать с детьми и подростками  
> в моменты их психологической уязвимости.
>
> Каждое решение, которое мы принимаем, потенциально влияет на чью-то жизнь.
>
> Это не преувеличение — это наша ответственность.

---

*Версия: 2.0 | Дата: Январь 2026 | БФ «Другой путь»*  
*Основано на принципах «Конституции Claude» (Anthropic, 2025)*
